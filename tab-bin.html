<!--
    ============================================================
    TAB-BIN.HTML - Bin Tab JavaScript
    ============================================================
    
    This file contains the JavaScript code for the Bin tab when running
    as a Google Apps Script web app. It handles:
    - Loading all rejected posts from Google Sheets
    - Displaying rejected posts in a list view
    - Restoring posts (changing status back to Generated)
    - Viewing post details (variants and images)
    
    ARCHITECTURE:
    - Acts like a recycle bin - users can view rejected posts
    - Restore functionality to send posts back for re-review
    - Expandable cards to view full post details
    - Uses default sheet name (single-user app)
    
    ============================================================
-->

<script>
/** ============================================================
 *  TAB-BIN.HTML - Recycle bin for rejected posts
 *  ============================================================ */

(function(){
  'use strict';
  
  // Get cache from global AppState
  const { cache, btnContent } = window.AppState;
  
  /**
   * Loads bin data and displays rejected posts.
   * 
   * Fetches all rejected posts and displays them in the bin view.
   * This function is called when the Bin tab is activated.
   * 
   * Uses caching to avoid unnecessary server calls.
   * 
   * @example
   * window.loadBin();
   * // Loads and displays all rejected posts
   */
  window.loadBin = function() {
    const binWrap = document.getElementById('binWrap');
    if (!binWrap) return;

    // Use default sheet name (single-user app)
    const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';
    const key = sheetName; // Cache key per sheet

    // Check cache first
    if (window.isCacheValid('bin') && cache.bin.sheet === key) {
      renderBin(cache.bin.data);
      return;
    }

    // Show loading message
    binWrap.innerHTML = '<div style="text-align:center;padding:40px;color:#666">Loading recycle bin for <strong>' +
      sheetName + '</strong>...</div>';

    // Fetch rejected posts from server
    google.script.run
      .withSuccessHandler(function(o){
        window.setCache('bin', o, { sheet: key });
        renderBin(o);
      })
      .withFailureHandler(function(){
        window.showToast('Error loading bin', 'bad');
      })
      .getRowsByStatus('Rejected', sheetName);
  };

  /**
   * Renders bin entries from server data.
   * 
   * Creates cards for each rejected post showing:
   * - Post ID, type, and status
   * - All three variants (expandable)
   * - All three images (expandable)
   * - Restore button to send back for review
   * 
   * @param {Object} o - Response object from getRowsByStatus()
   *   - rows: Array of rejected post objects
   * 
   * @example
   * renderBin({rows: [...]});
   */
  function renderBin(o) {
    const binWrap = document.getElementById('binWrap');
    if (!binWrap) return;
    
    const rows = (o && o.rows ? o.rows : []);
    binWrap.innerHTML = '';

    // Show empty state if no rejected posts
    if (rows.length === 0) {
      binWrap.innerHTML = '<div style="text-align:center;padding:40px;color:#666">Recycle bin is empty</div>';
      return;
    }

    // Create card for each rejected post
    rows.forEach(r => {
      const wrap = document.createElement('article');
      wrap.className = 'card';

      // ============================================================
      // CARD HEADER
      // ============================================================
      const header = document.createElement('header');
      header.innerHTML = 
        '<div class="left">' +
        '<button class="tarrow" title="Expand">▸</button>' +
        '<span class="chip">ID: <b>' + r.id + '</b></span>' +
        '<span class="chip">Status: <b>Rejected</b></span>' +
        '</div>' +
        '<div class="right">' +
        '<button class="btn undo" data-undo>Undo</button>' +
        '</div>';

      // ============================================================
      // CARD CONTENT SECTION (Collapsible)
      // ============================================================
      const section = document.createElement('section');
      section.className = 'content';
      section.style.display = 'none';

      // Variants section
      const vwrap = document.createElement('div');
      vwrap.className = 'variants';
      
      // Create variant elements
      ['variant_1', 'variant_2', 'variant_3'].forEach((vk, idx) => {
        const dv = document.createElement('div');
        dv.className = 'variant';
        dv.innerHTML = 
          '<div class="controls">' +
          '<div class="title">Variant ' + (idx + 1) + '</div>' +
          '</div>' +
          '<div class="text">' + 
          String(r[vk] || '').replace(/</g, '&lt;') +  // Escape HTML
          '</div>';
        vwrap.appendChild(dv);
      });

      // Images section
      const iwrap = document.createElement('div');
      iwrap.className = 'images';
      const imgs = [r.image_url_1, r.image_url_2, r.image_url_3].filter(Boolean);
      
      if (imgs.length) {
        imgs.forEach((u, ix) => {
          const cell = document.createElement('label');
          cell.className = 'imgCell';
          // Convert Google Drive URLs for image display
          const imgUrl = (typeof window.convertGoogleDriveUrl === 'function') 
            ? window.convertGoogleDriveUrl(u) 
            : u;
          cell.innerHTML = '<a target="_blank" rel="noopener" href="' + u + '">' +
            '<img src="' + imgUrl + '" alt="img" loading="lazy">' +
            '</a>';
          iwrap.appendChild(cell);
        });
      } else {
        iwrap.innerHTML = '<em>No images</em>';
      }

      section.appendChild(vwrap);
      section.appendChild(iwrap);
      wrap.appendChild(header);
      wrap.appendChild(section);

      // ============================================================
      // EXPAND/COLLAPSE HANDLER
      // ============================================================
      const arr = header.querySelector('.tarrow');
      arr.onclick = function() {
        if (section.style.display === 'none') {
          section.style.display = 'grid';
          arr.textContent = '▾';
        } else {
          section.style.display = 'none';
          arr.textContent = '▸';
        }
      };

      // ============================================================
      // RESTORE BUTTON HANDLER
      // ============================================================
      // Restores post by changing status back to "generated"
      header.querySelector('[data-undo]').onclick = function() {
        const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';
        
        google.script.run
          .withSuccessHandler(function(){
            window.showToast('Restored to generated', 'ok');
            window.clearCache();
            window.loadBin();
            
            // Refresh content tab if it's active
            if (btnContent.classList.contains('active') && 
                typeof window.fetchData === 'function') {
              window.fetchData();
            }
          })
          .withFailureHandler(function(e){
            window.showToast('Error: ' + e.message, 'bad');
          })
          .updateStatus(
            r.rowIndex,
            'generated',
            sheetName);
      };

      binWrap.appendChild(wrap);
    });
  }
  
  // ============================================================
  // BIN CONTAINER INITIALIZATION
  // ============================================================
  // Create bin container when page loads
  const binContainer = document.getElementById('binContainer');
  if (binContainer) {
    binContainer.innerHTML = '<div id="binWrap"></div>';
  }
  
  console.log('✓ Recycle Bin tab loaded');
  
})();
</script>

