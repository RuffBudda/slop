<!--
    ============================================================
    TAB-CALENDAR.HTML - Calendar Tab JavaScript
    ============================================================
    
    This file contains the JavaScript code for the Calendar tab when running
    as a Google Apps Script web app. It handles:
    - Displaying approved posts in a calendar grid view
    - Month navigation (previous/next month)
    - Drag-and-drop rescheduling of posts
    - Clicking posts to view details and edit schedule
    - Modal display for post details
    
    ARCHITECTURE:
    - Monday-start week layout
    - Highlights weekends and today's date
    - Drag-and-drop for quick rescheduling
    - Modal for detailed view and actions
    - Uses default sheet name (single-user app)
    
    ============================================================
-->

<script>
/** ============================================================
 *  TAB-CALENDAR.HTML - Monday-start calendar with drag-and-drop
 *  Shows final_img and final_content in modal
 *  ============================================================ */

(function(){
  'use strict';
  
  // Get cache and calendar month from global AppState
  const { cache, calMonth } = window.AppState;
  
  /**
   * Stores the post being dragged when user drags an event to reschedule.
   * Contains rowIndex, schedule date, and element reference.
   * 
   * @type {Object|null}
   */
  let draggedEvent = null;
  
  /**
   * Loads and displays calendar month with approved posts.
   * 
   * Fetches approved posts for a specific month and renders them
   * in a calendar grid. Posts are filtered by their post_schedule date.
   * 
   * Uses caching to avoid unnecessary server calls.
   * 
   * @param {Date} m - The month to display (Date object)
   * 
   * @example
   * window.loadCalendarMonth(new Date(2024, 0)); // January 2024
   */
  window.loadCalendarMonth = function(m) {
    // Use default sheet name (single-user app)
    const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';
    const key = sheetName + '|' + m.getFullYear() + '-' + m.getMonth();

    const calBody = document.getElementById('calBody');
    if (calBody) {
      calBody.innerHTML = `
        <div style="grid-column:1 / -1; padding:30px; text-align:center; color:#666;">
          Loading calendar for <strong>${sheetName}</strong>…
        </div>
      `;
    }
    
    // Check cache first
    if (window.isCacheValid('calendar') && cache.calendar.month === key) {
      renderCalendar(cache.calendar.data, m);
      return;
    }

    // Calculate date range for the month
    const y = m.getFullYear();
    const mon = m.getMonth();
    const startIso = new Date(y, mon, 1).toISOString();
    const endIso = new Date(y, mon + 1, 0, 23, 59, 59).toISOString();

    // Fetch approved posts for this month
    google.script.run
      .withSuccessHandler(function(o){
        window.setCache('calendar', o, {month: key});
        renderCalendar(o, m);
      })
      .withFailureHandler(function(){
        window.showToast('Error loading calendar', 'bad');
      })
      .getApprovedCalendar(startIso, endIso, sheetName);
  };
  
  /**
   * Renders the calendar grid with posts.
   * 
   * Creates a calendar grid for the specified month and populates
   * it with approved posts scheduled for each day.
   * 
   * Features:
   * - Monday-start week layout
   * - Weekend highlighting
   * - Today highlighting
   * - Draggable events
   * - Drop targets for rescheduling
   * 
   * @param {Object} o - Response object from getApprovedCalendar()
   *   - rows: Array of post objects with post_schedule dates
   * @param {Date} m - The month to render (Date object)
   * 
   * @example
   * renderCalendar({rows: [...]}, new Date(2024, 0));
   */
  function renderCalendar(o, m) {
    const events = (o && o.rows ? o.rows : []);
    
    // Update calendar title
    const calTitle = document.getElementById('calTitle');
    if (calTitle) {
      calTitle.textContent = m.toLocaleDateString(undefined, {
        month: 'long', 
        year: 'numeric'
      });
    }
    
    const y = m.getFullYear();
    const mon = m.getMonth();
    
    // Calculate first day of month (Monday = 0)
    const firstDate = new Date(y, mon, 1);
    const firstDay = (firstDate.getDay() + 6) % 7;  // Convert Sunday=0 to Monday=0
    
    const daysInMonth = new Date(y, mon + 1, 0).getDate();
    const today = new Date();

    const calBody = document.getElementById('calBody');
    if (!calBody) return;
    
    calBody.innerHTML = '';

    // Empty cells before first day of month
    for (let i = 0; i < firstDay; i++) {
      const cell = document.createElement('div');
      cell.className = 'calCell';
      calBody.appendChild(cell);
    }

    // Date cells for each day of the month
    for (let d = 1; d <= daysInMonth; d++) {
      const cell = document.createElement('div');
      cell.className = 'calCell';
      
      const date = new Date(y, mon, d);
      const dow = date.getDay();
      
      // Highlight weekends
      if (dow === 0 || dow === 6) {
        cell.classList.add('weekend');
      }
      
      // Highlight today
      if (today.toDateString() === date.toDateString()) {
        cell.classList.add('today');
      }

      // Date label
      const dt = document.createElement('div');
      dt.className = 'dt';
      dt.textContent = d;
      cell.appendChild(dt);

      // Filter events for this day
      const dayEvents = events.filter(e => {
        const eDate = new Date(e.post_schedule);
        return eDate.getDate() === d && 
               eDate.getMonth() === mon && 
               eDate.getFullYear() === y;
      });

      // ============================================================
      // DRAGGABLE EVENTS
      // ============================================================
      dayEvents.forEach(ev => {
        const evDiv = document.createElement('div');
        evDiv.className = 'ev';
        evDiv.draggable = true;
        
        // Format time for display
        const time = new Date(ev.post_schedule);
        evDiv.textContent = time.toLocaleTimeString([], {
          hour: '2-digit', 
          minute: '2-digit'
        }) + ' · ' + ev.id;
        
        // Store data for drag-and-drop
        evDiv.dataset.rowIndex = ev.row_index;
        evDiv.dataset.schedule = ev.post_schedule;
        
        // ============================================================
        // DRAG START HANDLER
        // ============================================================
        evDiv.ondragstart = function(e) {
          draggedEvent = {
            rowIndex: ev.row_index,
            schedule: ev.post_schedule,
            element: evDiv
          };
          evDiv.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        };
        
        // ============================================================
        // DRAG END HANDLER
        // ============================================================
        evDiv.ondragend = function() {
          evDiv.classList.remove('dragging');
          draggedEvent = null;
        };
        
        // ============================================================
        // CLICK HANDLER - Show modal
        // ============================================================
        evDiv.onclick = function() {
          showCalendarModal(ev);
        };
        
        cell.appendChild(evDiv);
      });
      
      // ============================================================
      // DROP TARGET HANDLERS
      // ============================================================
      // Allow dropping events on calendar cells
      cell.ondragover = function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };
      
      // Handle drop - reschedule the post
      cell.ondrop = function(e) {
        e.preventDefault();
        if (!draggedEvent) return;

        const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';

        // Calculate new date/time (preserve time, change date)
        const oldDate = new Date(draggedEvent.schedule);
        const newDate = new Date(y, mon, d, oldDate.getHours(), oldDate.getMinutes());
        const newIso = newDate.toISOString();

        // Show loader
        window.showLoader();

        // Update schedule on server
        google.script.run
          .withSuccessHandler(function(){
            window.hideLoader();
            window.showToast('Rescheduled to ' + newDate.toLocaleString(), 'ok');
            window.clearCache();
            window.loadCalendarMonth(m);
          })
          .withFailureHandler(function(err){
            window.hideLoader();
            window.showToast('Error: ' + err.message, 'bad');
          })
          .updatePostScheduleByRow(draggedEvent.rowIndex, newIso, sheetName);
      };

      calBody.appendChild(cell);
    }
  }
  
  /**
   * Shows a modal dialog with post details.
   * 
   * Displays post information including:
   * - Post ID and type
   * - Scheduled date/time
   * - Final content text
   * - Final images (if any)
   * - Action buttons (Reject, Reschedule)
   * 
   * @param {Object} ev - Post event object from calendar data
   *   - id: Post ID
   *   - Type: Post type
   *   - post_schedule: Scheduled date/time (ISO string)
   *   - final_content: Final approved content text
   *   - final_img: Final approved image URLs (comma-separated)
   *   - row_index: Row index in sheet
   * 
   * @example
   * showCalendarModal({id: 'POST-123', post_schedule: '2024-01-15T14:30:00Z', ...});
   */
  function showCalendarModal(ev) {
    const when = new Date(ev.post_schedule);
    
    // Create modal element
    const modal = document.createElement('dialog');
    modal.className = 'calModal';
    
    // Build modal HTML
    modal.innerHTML = `
      <button class="closeBtn">✕</button>
      <h2 style="margin:0 0 12px;font-weight:800">Scheduled Post</h2>
      <div>
        <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">
          <span class="chip">ID: <b>${ev.id}</b></span>
          <span class="chip">Time: <b>${when.toLocaleString(undefined, {
            month: 'short', 
            day: 'numeric', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit'
          })}</b></span>
        </div>
        <div style="white-space:pre-wrap;margin-top:12px">${ev.final_content || '(No content)'}</div>
      </div>
      <div style="display:flex;gap:10px;margin-top:18px;justify-content:space-between">
        <button class="btn reject"><span class="ico"></span> Reject</button>
        <button class="btn editBtn">Reschedule</button>
      </div>
    `;
    
    // Add final images if available
    if (ev.final_img) {
      const imgs = ev.final_img.split(',').map(s => s.trim()).filter(Boolean);
      if (imgs.length) {
        const grid = document.createElement('div');
        grid.className = 'gridImgs grid-' + Math.min(3, imgs.length);
        grid.style.marginTop = '12px';
        
        // Add up to 9 images
        imgs.slice(0, 9).forEach(u => {
          const a = document.createElement('a');
          a.href = u;
          a.target = '_blank';
          a.rel = 'noopener';
          const img = document.createElement('img');
          // Convert Google Drive URLs to working format
          img.src = (typeof window.convertGoogleDriveUrl === 'function') 
            ? window.convertGoogleDriveUrl(u) 
            : u;
          img.loading = 'lazy';
          a.appendChild(img);
          grid.appendChild(a);
        });
        
        modal.querySelector('div').appendChild(grid);
      }
    }
    
    // Append modal to body and show
    document.body.appendChild(modal);
    modal.showModal();
    
    // ============================================================
    // CLOSE BUTTON HANDLER
    // ============================================================
    modal.querySelector('.closeBtn').onclick = () => {
      modal.close();
      modal.remove();
    };
    
    // ============================================================
    // REJECT BUTTON HANDLER
    // ============================================================
    modal.querySelector('.reject').onclick = () => {
      const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';

      google.script.run
        .withSuccessHandler(() => {
          modal.close();
          modal.remove();
          window.showToast('Rejected', 'bad');
          window.clearCache();
          window.loadCalendarMonth(window.AppState.calMonth);
        })
        .withFailureHandler(e => window.showToast('Error: ' + e.message, 'bad'))
        .rejectAndClearByRow(ev.row_index, sheetName);
    };

    // ============================================================
    // RESCHEDULE BUTTON HANDLER
    // ============================================================
    modal.querySelector('.editBtn').onclick = () => {
      modal.close();
      modal.remove();

      const sheetName = (window.AppState && window.AppState.activeSheet) || 'Automated Content';

      // Show reschedule modal
      window.showRescheduleModal(
        ev.row_index,
        ev.post_schedule,
        sheetName,
        () => window.loadCalendarMonth(window.AppState.calMonth)
      );
    };
  }
  
  // ============================================================
  // CALENDAR CONTAINER INITIALIZATION
  // ============================================================
  // Build calendar HTML structure when page loads
  const calContainer = document.getElementById('calendarContainer');
  if (calContainer) {
    calContainer.innerHTML = `
      <div class="calHeader">
        <div class="title" id="calTitle"></div>
        <div class="ctrls">
          <button class="navBtn" id="calPrev">‹ Prev</button>
          <button class="navBtn" id="calToday">Today</button>
          <button class="navBtn" id="calNext">Next ›</button>
        </div>
      </div>
      <div class="calGrid">
        <div class="calDow">Mon</div>
        <div class="calDow">Tue</div>
        <div class="calDow">Wed</div>
        <div class="calDow">Thu</div>
        <div class="calDow">Fri</div>
        <div class="calDow">Sat</div>
        <div class="calDow">Sun</div>
      </div>
      <div class="calGrid" id="calBody"></div>
    `;
    
    // ============================================================
    // NAVIGATION BUTTON HANDLERS
    // ============================================================
    const calPrev = document.getElementById('calPrev');
    const calNext = document.getElementById('calNext');
    const calToday = document.getElementById('calToday');
    
    // Previous month button
    if (calPrev) {
      calPrev.onclick = function() {
        window.AppState.calMonth.setMonth(window.AppState.calMonth.getMonth() - 1);
        window.loadCalendarMonth(window.AppState.calMonth);
      };
    }
    
    // Next month button
    if (calNext) {
      calNext.onclick = function() {
        window.AppState.calMonth.setMonth(window.AppState.calMonth.getMonth() + 1);
        window.loadCalendarMonth(window.AppState.calMonth);
      };
    }
    
    // Today button - jump to current month
    if (calToday) {
      calToday.onclick = function() {
        window.AppState.calMonth = new Date();
        window.loadCalendarMonth(window.AppState.calMonth);
      };
    }
  }
  
  console.log('✓ Calendar tab loaded');
  
})();
</script>

