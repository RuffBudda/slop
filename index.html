<!--
    ============================================================
    INDEX.HTML - Google Apps Script Web App Main Interface
    ============================================================
    
    This is the main HTML file served by Google Apps Script when
    users access the web app URL. It provides the complete user
    interface for managing LinkedIn posts through Google Sheets.
    
    IMPORTANT: This file uses Google Apps Script template syntax:
    - <?!= include('styles') ?> - Includes styles.html file (unescaped HTML)
    - <?!= include('utils') ?> - Includes utils.html file
    - <?!= include('tab-content') ?> - Includes tab-content.html file
    - etc.
    
    The '!=' syntax means "output unescaped HTML" which is safe
    for including HTML content. Do not use '=' alone as it would
    escape HTML entities.
    
    This file is used when the app is deployed as a Google Apps
    Script web app, which allows it to run server-side code
    (Code.gs) while serving this HTML interface.
    
    ARCHITECTURE:
    - Single-user application (no multi-user sheet switching)
    - Four main tabs: Content, Calendar, List, Bin
    - Server-side processing through Apps Script
    - No client-side authentication required (runs as Apps Script user)
    
    ============================================================
-->

<!doctype html>
<html>
<head>
    <!-- Character encoding for proper text display -->
    <meta charset="utf-8"/>
    
    <!-- Viewport meta tag for mobile responsiveness -->
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    
    <!-- Page title displayed in browser tab -->
    <title>Slop Generator</title>
    
    <!-- 
        Include styles.html using Apps Script template syntax.
        The != means output the result unescaped (safe for HTML).
        This injects all CSS styles into the <head> section.
    -->
    <?!= include('styles'); ?>
</head>
<body>

<!-- ============================================================
     HEADER / NAVIGATION BAR
     ============================================================
     Contains:
     - Logo and application branding
     - Main navigation buttons (Content, Calendar, List, Bin)
     
     The header is sticky (stays at top when scrolling) and
     uses a dark background with white text for contrast.
-->
<div class="top">
    <div class="top-inner">
        <!-- Logo and Brand Section -->
        <!-- 
            Logo is loaded from DigitalOcean Spaces CDN for fast delivery.
            The logo.svg file contains the application branding.
        -->
        <div class="brand">
            <!-- 
                Logo image source points to DigitalOcean Spaces CDN.
                The SVG format ensures crisp display at any size.
            -->
            <img class="logo" id="appLogo" src="https://cdweya.blr1.cdn.digitaloceanspaces.com/logo.svg" alt="Application Logo">
        </div>

        <!-- 
            Main Navigation Buttons
            These buttons switch between the four main views of the application:
            - Content: Review and approve generated posts
            - Calendar: View scheduled posts in calendar format
            - List: View all approved posts in chronological list
            - Bin: View and restore rejected posts
        -->
        <div class="navBtns">
            <button class="navBtn active" id="btnContent">‚úè Content</button>
            <button class="navBtn" id="btnCalendar">üìÖ Calendar</button>
            <button class="navBtn" id="btnList">üìã List</button>
            <button class="navBtn" id="btnBin">üóë Bin</button>
        </div>
    </div>  
</div>

<!-- ============================================================
     CONTENT TAB VIEW
     ============================================================
     Main interface for reviewing and approving generated posts.
     
     This view displays posts that have status "generated" and
     allows users to:
     - Select a content variant (1, 2, or 3)
     - Select images (can select multiple)
     - Edit variant text inline
     - Upload custom images
     - Schedule the post
     - Approve or reject the post
     
     Content is loaded dynamically via Apps Script server-side code.
     The contentCards div is populated by JavaScript that calls
     google.script.run functions.
-->
<div class="wrap" id="contentView">
    <!-- 
        Initial Loading State
        Shows a spinner while content is being loaded from the server.
        Hidden once content is loaded or empty state is shown.
    -->
    <div class="initial">
        <div class="spinner-container">
            <div class="spinner"></div>
        </div>
        <p>Loading content...</p>
    </div>
    
    <!-- 
        Empty State
        Shown when there are no posts with status "generated" to review.
        Includes a refresh button to reload data.
    -->
    <div class="empty hidden">
        <div class="spinner-container">
            <div class="spinner"></div>
        </div>
        <p>No items pending in "generated".</p>
        <button class="btn gen" onclick="location.reload();">Refresh</button>
    </div>
    
    <!-- 
        Content Cards Container
        This div is populated dynamically by JavaScript with post cards.
        Each card represents one post with status "generated" and includes:
        - Post ID and type information
        - Three content variants (user selects one)
        - Three image options (user can select multiple)
        - Schedule date/time picker
        - Approve/Reject buttons
    -->
    <div id="contentCards"></div>
</div>

<!-- ============================================================
     CALENDAR TAB VIEW
     ============================================================
     Displays approved posts in a calendar grid format.
     
     Features:
     - Month navigation (previous/next)
     - Drag-and-drop rescheduling
     - Click posts to view details and edit schedule
     - Highlights today's date
     - Shows weekends with different styling
     
     The calendar uses a Monday-start week layout.
-->
<div class="wrap calWrap" id="calendarView">
    <!-- 
        Calendar Container
        Populated dynamically by JavaScript with calendar grid.
        Includes month header, day-of-week labels, and date cells.
    -->
    <div id="calendarContainer"></div>
</div>

<!-- ============================================================
     LIST/TIMELINE TAB VIEW
     ============================================================
     Displays all approved posts in chronological order.
     
     Features:
     - Sorted by scheduled date (earliest first)
     - Expandable cards to view full content
     - Shows final content and images (not variants)
     - Reschedule and reject actions
     - Dock integration for quick navigation
-->
<div id="timelineView">
    <!-- 
        Timeline Container
        Populated dynamically by JavaScript with timeline entries.
        Each entry shows date, time, post ID, and final content.
    -->
    <div id="timelineContainer"></div>
</div>

<!-- ============================================================
     BIN TAB VIEW
     ============================================================
     Displays all rejected posts (recycle bin).
     
     Features:
     - View rejected posts with their variants and images
     - Restore posts back to "generated" status for re-review
     - Expandable cards to view full details
-->
<div class="wrap" id="binView" style="display:none">
    <!-- 
        Bin Container
        Populated dynamically by JavaScript with rejected post cards.
        Each card includes restore functionality.
    -->
    <div id="binContainer"></div>
</div>

<!-- ============================================================
     MODALS - Dialog Windows
     ============================================================
     Modal dialogs for viewing post details and rescheduling.
-->

<!-- 
    Calendar Modal
    Shown when clicking a post in the calendar view.
    Displays post details and allows rescheduling or rejection.
-->
<dialog class="calModal" id="calModal">
    <button class="closeBtn" id="calCloseBtn">‚úï</button>
    <h2 style="margin:0 0 12px;font-weight:800">Scheduled Post</h2>
    <div id="calModalContent"></div>
    <div style="display:flex;gap:10px;margin-top:18px;justify-content:space-between">
        <button class="btn reject" id="calReject"><span class="ico"></span> Reject</button>
        <button class="btn editBtn" id="calResched">Reschedule</button>
    </div>
</dialog>

<!-- 
    Date/Time Picker Dialog
    Shown when rescheduling a post from calendar or timeline views.
    Allows user to select a new date and time for the post.
-->
<dialog id="dtDialog" style="border:1px solid var(--bd);border-radius:14px;padding:18px;max-width:340px">
    <h3 style="margin:0 0 12px">Pick Date & Time</h3>
    <div style="display:flex;flex-direction:column;gap:10px">
        <input type="date" id="dtDate" style="padding:8px;border:1px solid var(--bd2);border-radius:8px">
        <input type="time" id="dtTime" style="padding:8px;border:1px solid var(--bd2);border-radius:8px">
        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn approve" id="dtOk" style="flex:1"><span class="ico"></span> OK</button>
            <button class="btn clear" id="dtCancel" style="flex:1"><span class="ico"></span> Cancel</button>
        </div>
    </div>
</dialog>

<!-- ============================================================
     TOAST NOTIFICATIONS
     ============================================================
     Toast notifications appear at the bottom of the screen to
     provide user feedback for actions (success, error, info).
-->
<div class="toast-wrap" id="toastWrap"></div>

<!-- ============================================================
     FOOTER
     ============================================================
     Footer with copyright and version information.
-->
<div class="wrap" style="padding-top:0">
    <div style="display:flex;justify-content:flex-end;align-items:center;color:#666;font-size:13px">
        <div>¬© Slop Generator</div>
    </div>
</div>

<!-- ============================================================
     DOCK - Quick Navigation
     ============================================================
     Floating dock on the left side for quick navigation between posts.
     
     Features:
     - Shows post IDs as clickable dots
     - Highlights current post
     - Click to jump to specific post (Content tab) or scroll to it (List tab)
     - Only visible on Content and List tabs
-->
<div id="fabDock" class="dock">
    <!-- 
        Dock Button (FAB - Floating Action Button)
        Main button that expands to show post navigation dots.
    -->
    <button class="fab" title="Posts">
        <svg viewBox="0 0 48 48" width="26" height="26" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 8h18c2.2 0 4 1.8 4 4v3"/>
            <path d="M34 24v12c0 2.2-1.8 4-4 4H12c-2.2 0-4-1.8-4-4V16c0-2.2 1.8-4 4-4h6"/>
            <path d="M38.2 9.8a2.5 2.5 0 0 0-3.5 0L21 23.5l-.7 5.6 5.6-.7L40.3 14a2.5 2.5 0 0 0 0-3.5l-2.1-2.1z"/>
        </svg>
    </button>
    <!-- 
        Dock Items Container
        Populated dynamically with post ID dots for navigation.
    -->
    <div id="dockItems" class="dock-items"></div>
</div>

<!-- ============================================================
     INITIALIZATION SCRIPT
     ============================================================
     Sets up initial state and logs to console for debugging.
-->
<script>
// Log to console for debugging
console.log('Index loaded - starting to load modules');
</script>

<!-- ============================================================
     INCLUDE HTML MODULES
     ============================================================
     These includes inject JavaScript code from separate HTML files
     into this page. Each file handles a specific part of the
     application functionality.
     
     Order matters:
     1. utils.html - Utility functions and global state (must be first)
     2. tab-content.html - Content tab functionality
     3. tab-calendar.html - Calendar tab functionality
     4. tab-timeline.html - Timeline/List tab functionality
     5. tab-bin.html - Bin tab functionality
-->

<?!= include('utils'); ?>
<?!= include('tab-content'); ?>
<?!= include('tab-calendar'); ?>
<?!= include('tab-timeline'); ?>
<?!= include('tab-bin'); ?>

<!-- ============================================================
     LOGO MODAL
     ============================================================
     Modal dialog that opens when logo is clicked.
     Contains GIF, CO2/water calculator, and Contractors Direct branding.
-->
<dialog id="logoModal" class="logo-modal">
    <div class="logo-modal-content">
        <!-- Close Button -->
        <button class="logo-modal-close" id="logoModalClose" aria-label="Close modal">√ó</button>
        
        <!-- GIF Section -->
        <div class="logo-modal-gif">
            <img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExMGJmMzlycG01ZWs1cDdpYTQ0NnE2cmxzd2d2MWE3cXBuYTloa2txeCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/vX9WcCiWwUF7G/giphy.gif" alt="Animation" id="logoModalGif">
        </div>
        
        <!-- Calculator Section -->
        <div class="logo-modal-calculator">
            <h3 style="text-align: center;">üå≥ Environmental Impact Calculator üå≥</h3>
            
            <div class="calculator-input">
                <label for="postsPerWeek">Posts per week:</label>
                <div class="slider-container">
                    <input type="range" id="postsPerWeek" min="1" max="100" value="10" class="posts-slider">
                    <span class="slider-value" id="postsPerWeekValue">10</span>
                </div>
            </div>
            
            <!-- Individual Impact -->
            <div class="calculator-results">
                <h4>Your Impact</h4>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Per Day</div>
                        <div class="result-value" id="resultDayCO2">-</div>
                        <div class="result-unit">CO‚ÇÇ</div>
                        <div class="result-value" id="resultDayWater">-</div>
                        <div class="result-unit">Water</div>
                        <div class="result-value" id="resultDayTrees">-</div>
                        <div class="result-unit">Trees</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Per Month</div>
                        <div class="result-value" id="resultMonthCO2">-</div>
                        <div class="result-unit">CO‚ÇÇ</div>
                        <div class="result-value" id="resultMonthWater">-</div>
                        <div class="result-unit">Water</div>
                        <div class="result-value" id="resultMonthTrees">-</div>
                        <div class="result-unit">Trees</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Per Annum</div>
                        <div class="result-value" id="resultYearCO2">-</div>
                        <div class="result-unit">CO‚ÇÇ</div>
                        <div class="result-value" id="resultYearWater">-</div>
                        <div class="result-unit">Water</div>
                        <div class="result-value" id="resultYearTrees">-</div>
                        <div class="result-unit">Trees</div>
                    </div>
                </div>
                <div class="population-sources">
                    <small>
                        Sources: 
                        <a href="https://www.nature.com/articles/s41586-023-06083-8" target="_blank" rel="noopener">Nature - AI Carbon Footprint</a> (CO‚ÇÇ); 
                        <a href="https://www.sciencedirect.com/science/article/pii/S0306261922002063" target="_blank" rel="noopener">ScienceDirect - Data Center Water Usage</a> (Water); 
                        <a href="https://www.epa.gov/energy/greenhouse-gas-equivalencies-calculator" target="_blank" rel="noopener">EPA - GHG Equivalencies</a> (Trees)
                    </small>
                </div>
            </div>
            
            <!-- Population Impact -->
            <div class="calculator-population">
                <h4>If 100% of Population Used This</h4>
                <div class="population-warning">
                    <strong>‚ö†Ô∏è This automation is adding to a bigger problem</strong>
                </div>
                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">UAE (10M users)</div>
                        <div class="result-value" id="resultUAE_CO2">-</div>
                        <div class="result-unit">CO‚ÇÇ per annum</div>
                        <div class="result-value" id="resultUAE_Water">-</div>
                        <div class="result-unit">Water per annum</div>
                        <div class="result-value" id="resultUAE_Trees">-</div>
                        <div class="result-unit">Trees per annum</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">World (8B users)</div>
                        <div class="result-value" id="resultWorld_CO2">-</div>
                        <div class="result-unit">CO‚ÇÇ per annum</div>
                        <div class="result-value" id="resultWorld_Water">-</div>
                        <div class="result-unit">Water per annum</div>
                        <div class="result-value" id="resultWorld_Trees">-</div>
                        <div class="result-unit">Trees per annum</div>
                    </div>
                </div>
                <div class="population-sources">
                    <small>
                        Sources: 
                        <a href="https://www.uaestatistics.gov.ae/" target="_blank" rel="noopener">UAE Statistics Centre</a> / 
                        <a href="https://data.worldbank.org/" target="_blank" rel="noopener">World Bank</a> (UAE population); 
                        <a href="https://www.un.org/development/desa/pd/" target="_blank" rel="noopener">UN World Population Prospects</a> / 
                        <a href="https://www.worldometers.info/world-population/" target="_blank" rel="noopener">Worldometer</a> (World population)
                    </small>
                </div>
            </div>
            
            <!-- Real-World Comparisons -->
            <div class="calculator-comparison">
                <h4>Real-World Comparisons</h4>
                <p class="calculator-info" style="margin-bottom: 16px;">Your annual CO‚ÇÇ emissions are equivalent to:</p>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="comparison-icon">üöó</div>
                        <div class="comparison-value" id="resultDrives">-</div>
                        <div class="comparison-description">Drives from Dubai to Abu Dhabi</div>
                        <div class="comparison-bar-container">
                            <div class="comparison-bar" id="drivesBar"></div>
                        </div>
                        <div class="comparison-sources">
                            <small>
                                Source: 
                                <a href="https://www.epa.gov/energy/greenhouse-gas-equivalencies-calculator" target="_blank" rel="noopener">EPA GHG Calculator</a> / 
                                <a href="https://www.iea.org/data-and-statistics/data-tools/co2-emissions-calculator" target="_blank" rel="noopener">IEA CO‚ÇÇ Calculator</a>
                            </small>
                        </div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-icon">ü•©</div>
                        <div class="comparison-value" id="resultSteaks">-</div>
                        <div class="comparison-description">Steaks eaten</div>
                        <div class="comparison-bar-container">
                            <div class="comparison-bar" id="steaksBar"></div>
                        </div>
                        <div class="comparison-sources">
                            <small>
                                Source: 
                                <a href="https://www.nature.com/articles/s41586-021-03265-0" target="_blank" rel="noopener">Nature - Food Carbon Footprint</a> / 
                                <a href="https://www.sciencedirect.com/science/article/pii/S0959652617302188" target="_blank" rel="noopener">ScienceDirect - Beef LCA</a>
                            </small>
                        </div>
                    </div>
                    <div class="comparison-card">
                        <div class="comparison-icon">‚ö°</div>
                        <div class="comparison-value" id="resultTownhouse">-</div>
                        <div class="comparison-description">Years of electricity for a 4-bedroom townhouse</div>
                        <div class="comparison-bar-container">
                            <div class="comparison-bar" id="townhouseBar"></div>
                        </div>
                        <div class="comparison-sources">
                            <small>
                                Source: 
                                <a href="https://www.eia.gov/tools/faqs/faq.php?id=97&t=3" target="_blank" rel="noopener">EIA - Residential Energy Use</a> / 
                                <a href="https://www.epa.gov/energy/greenhouse-gas-equivalencies-calculator" target="_blank" rel="noopener">EPA GHG Calculator</a>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="comparison-card carbon-credit-card full-width">
                    <div class="comparison-icon">üåç</div>
                    <div class="carbon-credit-costs">
                        <div class="currency-display">
                            <span class="currency-label">USD:</span>
                            <span class="currency-value" id="resultCarbonUSD">-</span>
                        </div>
                        <div class="currency-display">
                            <span class="currency-label">AED:</span>
                            <span class="currency-value dirham-symbol" id="resultCarbonAED">-</span>
                        </div>
                    </div>
                    <div class="comparison-description">Carbon credits needed to offset your annual emissions</div>
                    <div class="comparison-sources">
                        <small>
                            Source: 
                            <a href="https://www.sustainable-markets.com/2024/07/16/an-overview-of-global-carbon-pricing-in-2024/" target="_blank" rel="noopener">Sustainable Markets - Carbon Pricing 2024</a> / 
                            <a href="https://www.ecosystemmarketplace.com/articles/state-of-the-voluntary-carbon-markets-2024/" target="_blank" rel="noopener">Ecosystem Marketplace - VCM Report</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Branding Section -->
        <div class="logo-modal-branding">
            <img src="https://contractors.direct/hs-fs/hubfs/Contractors%20Direct%20Theme%20-%202024/Assets/Images/Header_logo_image.png?width=116&height=72&name=Header_logo_image.png" alt="Contractors Direct" class="contractors-logo">
            <p>Created by the team @ Contractors Direct</p>
            <a href="https://contractors.direct" target="_blank" rel="noopener" class="btn approve contractors-btn">Visit Contractors Direct</a>
        </div>
    </div>
</dialog>

<!-- ============================================================
     APP LOADER (Initial Page Load)
     ============================================================
     Full-screen loading overlay shown when app first loads.
     Hidden when DOM is ready and initial data fetch completes.
-->
<div id="appLoader" class="app-loader">
    <div class="spinner-container">
        <div class="spinner"></div>
    </div>
</div>

<!-- ============================================================
     GLOBAL LOADER
     ============================================================
     Full-screen loading overlay shown during server operations.
     Uses a CSS spinner animation instead of GIF.
-->
<div id="globalLoader" class="loader hidden">
    <div class="spinner"></div>
</div>

<!-- ============================================================
     INITIALIZATION SCRIPT
     ============================================================
     Sets up the application when the page loads.
     Initializes AppState and sets default active sheet.
-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Initialize global application state
    window.AppState = window.AppState || {};
    
    // Set default active sheet (single-user app, always uses default)
    window.AppState.activeSheet = window.AppState.activeSheet || 'Automated Content';
    
    // Note: Sheet switching logic has been removed for single-user app
    // All functions now use the default sheet automatically
    
    // Attach logo click handler (fallback if utils.html hasn't loaded yet)
    function attachLogoClickHandler() {
        const appLogo = document.getElementById('appLogo');
        if (appLogo && !appLogo.hasAttribute('data-handler-attached')) {
            appLogo.setAttribute('data-handler-attached', 'true');
            appLogo.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (typeof window.openLogoModal === 'function') {
                    window.openLogoModal();
                } else {
                    // Fallback: open modal directly
                    const modal = document.getElementById('logoModal');
                    if (modal) {
                        modal.showModal();
                        if (typeof window.updateCalculator === 'function') {
                            window.updateCalculator();
                        }
                    }
                }
            });
        }
    }
    
    // Try immediately and after a delay
    attachLogoClickHandler();
    setTimeout(attachLogoClickHandler, 100);
    setTimeout(attachLogoClickHandler, 500);
    
    // Hide app loader logic
    const appLoader = document.getElementById('appLoader');
    const minDisplayTime = 500; // Minimum 500ms to prevent flash
    const startTime = Date.now();
    let loaderHidden = false;
    
    // Function to hide loader when ready
    const hideAppLoader = () => {
        if (loaderHidden) return;
        loaderHidden = true;
        
        const elapsed = Date.now() - startTime;
        const remaining = Math.max(0, minDisplayTime - elapsed);
        
        setTimeout(() => {
            if (appLoader) {
                appLoader.classList.add('hidden');
            }
        }, remaining);
    };
    
    // Wait for utils to load, then check for fetchData
    setTimeout(() => {
        // Hide loader after a reasonable delay if fetchData hasn't been called
        // This ensures loader doesn't stay forever
        setTimeout(hideAppLoader, 2000);
        
        // If fetchData exists, wrap it to hide loader on completion
        if (typeof window.fetchData === 'function') {
            const originalFetchData = window.fetchData;
            window.fetchData = function() {
                const result = originalFetchData.apply(this, arguments);
                // Hide loader after fetch completes (with delay for smooth transition)
                setTimeout(hideAppLoader, 300);
                return result;
            };
        }
    }, 100);
    
    // Also hide loader if initial element is hidden (content loaded)
    const checkInitialState = () => {
        const initial = document.querySelector('#contentView .initial');
        if (initial && initial.classList.contains('hidden')) {
            hideAppLoader();
        }
    };
    
    // Check periodically for initial state change
    const checkInterval = setInterval(() => {
        checkInitialState();
        if (loaderHidden) {
            clearInterval(checkInterval);
        }
    }, 100);
    
    // Clear interval after 5 seconds max
    setTimeout(() => {
        clearInterval(checkInterval);
        hideAppLoader();
    }, 5000);
});
</script>

</body>
</html>

